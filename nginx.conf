# Nginx configurado solo para actuar como Reverse Proxy HTTPS para la API de Django.
# La raíz (/) ahora la sirve Vercel, no este Nginx.

server {
    # Escucha en el puerto HTTPS
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name matemania.cl www.matemania.cl;

    # ----------------------------------------------------
    # 1. Configuración de Certificados SSL (Generados por Certbot)
    # ----------------------------------------------------
    ssl_certificate /etc/letsencrypt/live/matemania.cl/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matemania.cl/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
    ssl_prefer_server_ciphers on;

    # ----------------------------------------------------
    # 2. Proxy Inverso para la API de Django (/api/)
    # ----------------------------------------------------
    location /api/ {
        # ¡IMPORTANTE! Comunicación interna a Django es SIEMPRE HTTP
        proxy_pass http://matemania-backend:8000/api/; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # CRUCIAL: Le dice a Django que la petición original fue HTTPS
        proxy_set_header X-Forwarded-Proto $scheme; 
    }

    # ----------------------------------------------------
    # 3. Bloque Raíz (/) - IMPIDE QUE NGINX SIRVA EL FRONTEND
    # ----------------------------------------------------
    location / {
        # Como Vercel maneja la raíz, si algo llega aquí, simplemente devolvemos 404.
        # Esto asegura que Nginx no intente servir archivos estáticos del frontend.
        return 404; 
    }
}

# ----------------------------------------------------
# 4. Redirección de HTTP (Puerto 80) a HTTPS (443)
# ----------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name matemania.cl www.matemania.cl;

    # Bloque EXCLUSIVO para la validación de Certbot 
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot; 
        try_files $uri $uri/ =404;
    }

    # Redirección forzada de todo lo demás a HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}
